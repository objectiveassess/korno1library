<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>관리자 - QR 토큰 생성</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="app">
    <div class="page-header">
      <div class="page-title">관리자 - QR 생성</div>
      <div class="page-subtitle">오늘 출근/퇴근 QR 토큰과 QR 코드를 생성합니다.</div>
    </div>

    <div class="card center">
      <div class="table-title">출근 QR</div>
      <button class="primary" style="margin-top:10px;" onclick="makeCheckInToken()">출근 QR 토큰 만들기</button>
      <p id="checkInResult" class="status"></p>
      <div id="checkInQR" class="qr-area"></div>
    </div>

    <div class="card center">
      <div class="table-title">퇴근 QR</div>
      <button class="primary" style="margin-top:10px;" onclick="makeCheckOutToken()">퇴근 QR 토큰 만들기</button>
      <p id="checkOutResult" class="status"></p>
      <div id="checkOutQR" class="qr-area"></div>
    </div>

    <div class="card">
      <div class="table-title">상태</div>
      <p id="status" class="status">대기 중...</p>
      <p class="status small" style="margin-top:4px;">
        출석부 확인: <a href="admin_report.html" class="link">오늘 전체 출석부 보기</a>
      </p>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <!-- QR 코드 라이브러리 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCvlmk_jldq85UnFNvaLGQGtGcQVOzti8s",
      authDomain: "korno1library.firebaseapp.com",
      projectId: "korno1library",
      storageBucket: "korno1library.appspot.com",
      messagingSenderId: "407619436872",
      appId: "1:407619436872:web:7fdd65b77eed5f84aa737d"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const statusEl = document.getElementById("status");
    const checkInResult = document.getElementById("checkInResult");
    const checkOutResult = document.getElementById("checkOutResult");

    function getToday() {
      const d = new Date();
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
    }
    const today = getToday();

    function randomToken(prefix) {
      return prefix + Math.random().toString(36).substring(2, 10);
    }

    let checkInQR, checkOutQR;

    async function makeCheckInToken() {
      try {
        statusEl.textContent = "출근 토큰 생성 중...";
        const token = randomToken("CI_");
        await db.collection("tokens").doc(today).set(
          { checkInToken: token },
          { merge: true }
        );

        const url = `${window.location.origin}/checkin.html?token=${token}`;
        checkInResult.innerHTML = `출근 토큰: <b>${token}</b><br><span class="small">${url}</span>`;

        if (!checkInQR) {
          checkInQR = new QRCode("checkInQR", {
            text: url,
            width: 160,
            height: 160
          });
        } else {
          checkInQR.clear();
          checkInQR.makeCode(url);
        }

        statusEl.textContent = "출근 토큰 생성 완료!";
      } catch (e) {
        console.error(e);
        statusEl.textContent = "출근 토큰 생성 중 에러: " + e.message;
      }
    }

    async function makeCheckOutToken() {
      try {
        statusEl.textContent = "퇴근 토큰 생성 중...";
        const token = randomToken("CO_");
        await db.collection("tokens").doc(today).set(
          { checkOutToken: token },
          { merge: true }
        );

        const url = `${window.location.origin}/checkout.html?token=${token}`;
        checkOutResult.innerHTML = `퇴근 토큰: <b>${token}</b><br><span class="small">${url}</span>`;

        if (!checkOutQR) {
          checkOutQR = new QRCode("checkOutQR", {
            text: url,
            width: 160,
            height: 160
          });
        } else {
          checkOutQR.clear();
          checkOutQR.makeCode(url);
        }

        statusEl.textContent = "퇴근 토큰 생성 완료!";
      } catch (e) {
        console.error(e);
        statusEl.textContent = "퇴근 토큰 생성 중 에러: " + e.message;
      }
    }

    statusEl.textContent = `오늘 날짜: ${today} · 대기 중`;
  </script>
</body>
</html>
