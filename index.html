<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>도서관 공부 랭킹 - 로그인</title>
  <link rel="stylesheet" href="style.css">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCvlmk_jldq85UnFNvaLGQGtGcQVOzti8s",
      authDomain: "korno1library.firebaseapp.com",
      projectId: "korno1library",
      storageBucket: "korno1library.appspot.com",
      messagingSenderId: "407619436872",
      appId: "1:407619436872:web:7fdd65b77eed5f84aa737d"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>
</head>

<body>
  <div class="app">
    <div class="page-header">
      <div class="page-title">도서관 공부 랭킹</div>
      <div class="page-subtitle">닉네임과 4자리 PIN으로 로그인하세요.</div>
    </div>

    <div class="card">
      <label for="nickname">닉네임</label>
      <input type="text" id="nickname" placeholder="예: 민수킹" />

      <label for="pin">비밀번호 (4자리 숫자)</label>
      <input type="password" id="pin" maxlength="4" placeholder="0000" />

      <label for="exam">준비 중인 시험</label>
      <select id="exam">
        <option value="">선택</option>
        <option value="공무원">공무원</option>
        <option value="임용">임용</option>
        <option value="편입">편입</option>
        <option value="CPA">CPA</option>
        <option value="로스쿨">로스쿨</option>
        <option value="수능">수능</option>
        <option value="기타">기타</option>
      </select>

      <button class="primary" onclick="login()">로그인</button>
      <p id="message" class="message"></p>
    </div>
  </div>

  <script>
    async function login() {
      const nickname = document.getElementById("nickname").value.trim();
      const pin = document.getElementById("pin").value.trim();
      const exam = document.getElementById("exam").value;
      const msgEl = document.getElementById("message");
      msgEl.className = "message";

      if (!nickname) {
        msgEl.textContent = "닉네임을 입력하세요.";
        msgEl.classList.add("error");
        return;
      }
      if (!/^\d{4}$/.test(pin)) {
        msgEl.textContent = "PIN은 숫자 4자리여야 합니다.";
        msgEl.classList.add("error");
        return;
      }

      try {
        const userDoc = await db.collection("users").doc(nickname).get();

        if (userDoc.exists) {
          const savedPin = userDoc.data().pin;
          if (savedPin !== pin) {
            msgEl.textContent = "이미 존재하는 닉네임입니다. PIN이 일치하지 않습니다.";
            msgEl.classList.add("error");
            return;
          }
        } else {
          await db.collection("users").doc(nickname).set({
            pin,
            examCategory: exam || "미설정",
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        }

        localStorage.setItem("nickname", nickname);
        localStorage.setItem("pin", pin);
        localStorage.setItem("examCategory", exam || "미설정");

        msgEl.textContent = "로그인 성공! 프로필로 이동합니다.";
        msgEl.classList.add("success");

        setTimeout(() => {
          window.location.href = "main.html";
        }, 400);
      } catch (e) {
        console.error(e);
        msgEl.textContent = "로그인 중 오류가 발생했습니다.";
        msgEl.classList.add("error");
      }
    }

    window.addEventListener("load", async () => {
      const savedNickname = localStorage.getItem("nickname");
      if (savedNickname) {
        document.getElementById("nickname").value = savedNickname;
      }
    });
  </script>
</body>
</html>
