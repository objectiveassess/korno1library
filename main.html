<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>도서관 공부 랭킹 - 메인</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="app">
    <h1>도서관 공부 랭킹</h1>
    <p class="subtitle">QR로 출근/퇴근하고, 오늘 공부시간을 랭킹으로 확인하세요.</p>

    <div class="section">
      <div id="userInfo" class="info-chip">내 정보 불러오는 중...</div>
      <p id="myStudyTime" class="status">내 오늘 공부시간: 계산 중...</p>

      <div class="chart-box">
        <canvas id="myChart" height="160"></canvas>
      </div>

      <p style="margin-top:8px; font-size:12px;">
        <a href="index.html" class="link">다른 계정으로 로그인</a>
      </p>
    </div>

    <div class="section">
      <h2>오늘 전체 랭킹 Top 10</h2>
      <table>
        <thead>
          <tr>
            <th>순위</th>
            <th>닉네임</th>
            <th>시험</th>
            <th>분</th>
          </tr>
        </thead>
        <tbody id="overallRankBody">
          <tr><td colspan="4">불러오는 중...</td></tr>
        </tbody>
      </table>
    </div>

    <div class="section">
      <h2>오늘 내 카테고리 랭킹 Top 10</h2>
      <table>
        <thead>
          <tr>
            <th>순위</th>
            <th>닉네임</th>
            <th>분</th>
          </tr>
        </thead>
        <tbody id="categoryRankBody">
          <tr><td colspan="3">불러오는 중...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCvlmk_jldq85UnFNvaLGQGtGcQVOzti8s",
      authDomain: "korno1library.firebaseapp.com",
      projectId: "korno1library",
      storageBucket: "korno1library.appspot.com",
      messagingSenderId: "407619436872",
      appId: "1:407619436872:web:7fdd65b77eed5f84aa737d"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const nickname = localStorage.getItem("nickname");
    const pin = localStorage.getItem("pin");
    let examCategory = localStorage.getItem("examCategory") || "미설정";

    if (!nickname || !pin) {
      alert("먼저 로그인해야 합니다!");
      window.location.href = "index.html";
      throw new Error("not logged in");
    }

    const userInfoEl = document.getElementById("userInfo");
    const myStudyTimeEl = document.getElementById("myStudyTime");
    const overallRankBody = document.getElementById("overallRankBody");
    const categoryRankBody = document.getElementById("categoryRankBody");

    function getToday() {
      const d = new Date();
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
    }
    const today = getToday();

    async function loadUserInfo() {
      const userRef = db.collection("users").doc(nickname);
      const doc = await userRef.get();
      if (doc.exists) {
        const data = doc.data();
        examCategory = data.examCategory || examCategory;
        localStorage.setItem("examCategory", examCategory);
      }
      userInfoEl.textContent = `닉네임: ${nickname} · 시험: ${examCategory}`;
    }

    let todayMinutes = 0;
    const DAILY_GOAL = 600; // 10시간 목표
    let chart;

    async function loadMyStudyTime() {
      const sessRef = db.collection("sessions")
        .where("nickname", "==", nickname)
        .where("date", "==", today);
      const snap = await sessRef.get();

      if (snap.empty) {
        myStudyTimeEl.textContent = "내 오늘 공부시간: 아직 출근 기록이 없습니다.";
        todayMinutes = 0;
      } else {
        const data = snap.docs[0].data();
        todayMinutes = data.totalMinutes || 0;
        myStudyTimeEl.textContent = `내 오늘 공부시간: 약 ${todayMinutes}분`;
      }
      drawChart();
    }

    function drawChart() {
      const ctx = document.getElementById("myChart").getContext("2d");
      const done = todayMinutes;
      const remain = Math.max(0, DAILY_GOAL - done);

      if (chart) chart.destroy();

      chart = new Chart(ctx, {
        type: "doughnut",
        data: {
          labels: ["오늘 공부한 시간", "남은 목표"],
          datasets: [{
            data: [done, remain],
            backgroundColor: ["#2563eb", "#e5e7eb"],
            borderWidth: 0
          }]
        },
        options: {
          plugins: {
            legend: {
              display: true,
              position: "bottom",
              labels: {
                boxWidth: 12,
                font: { size: 11 }
              }
            }
          },
          cutout: "70%"
        }
      });
    }

    async function loadOverallRanking() {
      const rankRef = db.collection("sessions")
        .where("date", "==", today)
        .orderBy("totalMinutes", "desc")
        .limit(10);
      const snap = await rankRef.get();

      overallRankBody.innerHTML = "";
      let rank = 1;

      snap.forEach(doc => {
        const d = doc.data();
        const tr = document.createElement("tr");
        const cat = d.examCategory || "미설정";
        tr.innerHTML = `
          <td>${rank}</td>
          <td>${d.nickname}</td>
          <td>${cat}</td>
          <td>${d.totalMinutes || 0}</td>
        `;
        overallRankBody.appendChild(tr);
        rank++;
      });

      if (rank === 1) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="4">아직 오늘 공부 기록이 없습니다.</td>`;
        overallRankBody.appendChild(tr);
      }
    }

    async function loadCategoryRanking() {
      categoryRankBody.innerHTML = "";

      if (!examCategory || examCategory === "미설정") {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="3">시험 카테고리가 설정되지 않았습니다.</td>`;
        categoryRankBody.appendChild(tr);
        return;
      }

      const rankRef = db.collection("sessions")
        .where("date", "==", today)
        .where("examCategory", "==", examCategory)
        .orderBy("totalMinutes", "desc")
        .limit(10);

      const snap = await rankRef.get();

      let rank = 1;
      snap.forEach(doc => {
        const d = doc.data();
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${rank}</td>
          <td>${d.nickname}</td>
          <td>${d.totalMinutes || 0}</td>
        `;
        categoryRankBody.appendChild(tr);
        rank++;
      });

      if (rank === 1) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="3">아직 이 카테고리에는 공부 기록이 없습니다.</td>`;
        categoryRankBody.appendChild(tr);
      }
    }

    async function main() {
      await loadUserInfo();
      await loadMyStudyTime();
      await loadOverallRanking();
      await loadCategoryRanking();
    }

    main();
  </script>
</body>
</html>
